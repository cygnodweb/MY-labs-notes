


# ğŸ“˜ Format String Vulnerability
---

## ğŸ” 1. Introduction

**Format String Vulnerability** is a type of **memory corruption bug** that arises when **untrusted input is passed as a format string** to a formatted output function (like `printf` in C/C++), allowing attackers to:

- Read arbitrary memory
    
- Write arbitrary memory
    
- Potentially achieve **code execution**
    

---

## ğŸ§  2. How Format Strings Work

Formatted functions (like `printf`, `sprintf`, etc.) in C use **format specifiers** to control how data is presented.

`printf("Hello %s, your age is %d", name, age);`

Here:

- `%s`: expects a `char*` (string)
    
- `%d`: expects an `int`
    

These format specifiers **consume arguments from the stack** in order.

                      +---------------------------+
                      |     Format String Input   |
                      |   e.g., "Value: %x %x"    |
                      +-------------+-------------+
                                    |
                                    v
                    +-------------------------------+
                    |     printf("Value: %x %x");    |
                    +-------------------------------+
                                    |
                                    v
                +-------------------------------------------+
                |     Format String Parser (in printf)      |
                |  - Looks for format specifiers (%x, %s)   |
                |  - Pulls values from the stack            |
                +----------------+--------------------------+
                                 |
                +-------------------------------+
                |   Stack-based Argument Access  |
                +-------------------------------+
                                 |
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ Stack Layout (32-bit x86)  â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â–¼
`+-------------------------------+`
`| Return Address                |
`+-------------------------------+`
`| Format String Pointer         | â† used by printf
`+-------------------------------+
`| Argument 1 (e.g., int a = 5)  | â† %x accesses this
`+-------------------------------+
`| Argument 2 (e.g., int b = 10) | â† %x accesses this
`+-------------------------------+`
`| ...                           |
`+-------------------------------+`              â–¼
`+----------------------------------------+
`|  Output Based on Format Specifiers     |`
`|  E.g., Output: "Value: 5 aabbccdd"     |`
``+----------------------------------------+`








---

## âš™ï¸ 3. Behind the Scenes â€“ Stack-Based Execution

When you write:
`printf("Value: %x %x");`

Internally:

- The format string is parsed left to right.
    
- Each `%x` consumes 4 bytes (an argument) from the **stack**.
    

If no extra arguments are given, it will still pop from the stack anyway (undefined behavior), printing unintended memory addresses (stack data).

---

## ğŸš¨ 4. Vulnerability Example

### âŒ Vulnerable Code:
`char input[100]; scanf("%s", input); printf(input);  // Dangerous`

### Malicious Input:

`AAAA %x %x %x %x`

â¡ï¸ Output:
`AAAA deadbeef 80483f4 bffffaaa 41414141`

Shows:

- Stack values
    
- Potential pointer leaks (addresses of libc, etc.)
    

---

## ğŸ”  5. Format Specifiers â€“ Complete Reference

|Format|Meaning|Example|
|---|---|---|
|`%d`|Signed decimal integer|`42`|
|`%i`|Same as `%d`|`42`|
|`%u`|Unsigned decimal integer|`42`|
|`%x`|Unsigned hexadecimal (lowercase)|`2a`|
|`%X`|Unsigned hexadecimal (uppercase)|`2A`|
|`%o`|Unsigned octal|`52`|
|`%f`|Float (fixed-point)|`3.14`|
|`%e`|Scientific (lowercase)|`3.14e+00`|
|`%E`|Scientific (uppercase)|`3.14E+00`|
|`%g`|Compact float or scientific|`3.14`|
|`%G`|Same as `%g` but uppercase|`3.14`|
|`%c`|Character|`A`|
|`%s`|String|`"hello"`|
|`%p`|Pointer address|`0xdeadbeef`|
|`%n`|Writes number of characters printed so far to a memory location (used in attacks!)||
|`%%`|Literal percent sign|`%`|

---

## ğŸ§¨ 6. Attack Techniques

### âœ… Information Leak

`printf(user_input);  // "%x %x %x"`

â¡ï¸ Leaks stack memory, which may contain:

- Return addresses
    
- Pointers to libc
    
- Environment variables
    
- Passwords or tokens
    

---

### âœ… Reading Arbitrary Memory

`char *ptr = 0xdeadbeef; printf("%s", ptr);  // May crash or print memory`

### âœ… Writing Arbitrary Memory

Using `%n`:
`int target = 0; printf("AAAA%n", &target);`

â¡ï¸ Writes `4` (number of characters printed so far) into `target`.

Attackers craft input like:
`\x10\x84\x04\x08 %n`

â¡ï¸ Overwrites memory at address `0x08048410`.

---

## ğŸ”¬ 7. Memory Mechanics

In 32-bit x86 calling conventions:

- Arguments are passed on the **stack**
    
- Format string interprets stack arguments as values
    

### Example:

`printf("A: %x B: %x C: %x");`

â¡ï¸ Each `%x` reads 4 bytes from the stack

**Stack Layout Visualization:**
Stack (top â†“)
**| arg3              | â† %x**
**| arg2              | â† %x**
**| arg1              | â† %x**
**| format string ptr |**
**| return address    |**

---

## ğŸ¯ 8. Exploit Payload Crafting

To **write 4 bytes to address 0x0804a010**:
`payload = "\x10\xa0\x04\x08"    # Address (little endian)
        `+ "AAAA"
        `+ "%123x"                # Pad to 123 chars
        `+ "%n"                   # Write 123 to address

â¡ï¸ Uses `%n` to write character count to memory.

Can be extended using `%hn`, `%hhn` for partial writes.

---

## ğŸ“Š 9. Diagram â€“ Format String Exploit Lifecycle
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Untrusted Input (user)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Used directly in printf()  â”‚
  â”‚ e.g., printf(input);       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Stack arguments accessed     â”‚
   â”‚ (%x, %n, %s, etc.)           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Leak info / Write memory / Crash   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

---

## ğŸ›¡ï¸ 10. Prevention Techniques

|Method|Description|
|---|---|
|âœ… Use fixed format strings|`printf("%s", input);`|
|âŒ Avoid passing input directly|Never use `printf(input);`|
|ğŸ›  Enable compiler warnings|`-Wall -Wformat -Wformat-security`|
|ğŸ§¼ Sanitize input|Remove `%`, or limit characters|
|ğŸ§ª Use safer functions|`snprintf`, `fgets`, `strncpy`, etc.|
|ğŸ” Stack protection (canaries)|Detects buffer overflows before return|
|ğŸš« Disable `%n` (glibc patch)|Use secure libraries that restrict `%n` usage|
|ğŸ§° Use static analyzers|Detect vulnerable format string calls|

---

## ğŸ§° 11. Tools for Detection

| Tool                    | Use Case                    |
| ----------------------- | --------------------------- |
| Flawfinder              | Detect format string issues |
| RATS                    | Source code analysis        |
| Valgrind                | Runtime memory debugging    |
| AddressSanitizer (ASan) | Memory safety               |
| Fortify                 | Compile-time protection     |

---

## ğŸ§ª 12. Real-World Exploits

### Format String used in:

- **WU-FTPD** exploit
    
- **snprintf() overflow in BSD**
    
- **CUPS printing system bug**
    
- **Syslog format string vulnerabilities**
    

These bugs often leak **stack, libc, or PIE base addresses** â†’ lead to full **Remote Code Execution (RCE)**.

---

## ğŸ§  13. Summary Cheat Sheet

|Aspect|Details|
|---|---|
|**Vulnerability**|Format string misuse|
|**Languages Affected**|C, C++, low-level systems|
|**Key Specifiers**|`%x`, `%s`, `%n`, `%p`, `%d`, `%hhn`, `%hn`|
|**Impact**|Info leak, memory write, control hijack|
|**Main Prevention**|Never let user control format string|
|**Tooling**|Flawfinder, ASan, Fortify, compiler flags|
|**Exploit Technique**|Stack memory traversal via format string|
